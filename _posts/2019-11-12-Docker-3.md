---
title: Docker 3
published: true
---

# Chapter 3 이미지 레지스트리와 도커허브

## 1. 이미지 레지스트리란

응용프로그램을 컨테이너 이미지로 패키징하는 것은 `docker image build` 명령어를 이용해 손쉽게 할 수 있습니다. 하지만 이를 통해 만들어진 이미지는 로컬 캐쉬에만 존재합니다. 이미지를 잘 사용하려면 다른 컴퓨터에서도 사용할 수 있어야 합니다. 이미지 레지스트리는 공유된 이미지의 주소를 의미합니다. 이 주소를 사용해서 자신이 만든 이미지를 푸시하거나 다른 사람이 만든 이미지를 pul할 수 있습니다 (GitHub에서 푸시와 풀하는 것처럼). 이미지 레지스트리는 도커의 주요한 기능 중 하나입니다.

[도커허브](https://hub.docker.com)는 Docker, Inc.가 관리하는 공용 무료 이미지 레지스트리입니다. 도커허브에는 90만개가 넘는 이미지가 존재하고, 120억번이 넘는 이미지 풀이 일어났습니다. 누구나 도커허브에 이미지를 푸시할 수 있으며 공식적인 이미지도 존재합니다.

도커허브에는 다양한 기능이 있고, 기본으로 지정되어 있는 저장소이기 때문에 처음에는 도커허브를 사용하는 것이 좋습니다. 하지만, 써드파티 저장소를 사용하고 싶다면 사용할 수 있습니다. 이 챕터에서는 도커허브를 사용하도록 하겠습니다.

## 2. 도커허브 사용법

도커허브는 Docker, Inc.에서 제공하는 공용 이미지 레지스트리입니다. 도커허브는 도커엔진의 기본 레지스트리입니다. 도커허브는 계정이 없더라도 이미지를 풀할 수 있습니다. 지금까지는 별다른 설정없이 도커허브에서 다운로드 받은 이미지를 이용해 컨테이너를 실행시켰습니다.

도커허브에 이미지를 푸시하기 위해서는 계정이 필요합니다. [도커허브](https://hub.docker.com)에서 무료 계정을 만들 수 있습니다. 사용자명은 이미지를 빌드할 때 레포지토리 이름의 사용자명 부분과 같아야 합니다 (만약 사용자명이 `kuicsofficial`이라면 `kuicsofficial`이 앞에 붙은 이미지만 푸시할 수 있습니다.). 도커허브에 private 레포지토리를 만들 수 있습니다 (무료계정은 하나의 private 레포지토리만 만들 수 있습니다.).

> 레지스트리와 레포지토리는 다른 것입니다. 레지스트리는 여러개의 레포지토리가 모인 것입니다.

도커허브에서 계정을 만든 뒤에 `docker login`명령어를 통해 로그인할 수 있습니다.

![Result of docker login](/blog/assets/2019-11-12-Docker-3/docker_login.png)

이제 `image push` 명령어를 사용해 이미지를 푸시할 수 있습니다.

![Result of image push](/blog/assets/2019-11-12-Docker-3/image_push.png)

푸시는 만약 레지스트리에 같은 레이어가 있다면, 푸시하지 않습니다. 위의 예시에서 기초 이미지를 공식 우분투 이미지에서 mount하고 있습니다. 만약 도커파일을 수정해서 푸시하면 밑의 레이어는 이미 레지스트리에 있으므로 맨 위의 레이어만 푸시합니다.

도커허브에 레포지토리를 생성하면, `docker container run`에 이미지 태그를 사용해 컨테이너를 실행시킬 수 있습니다(여기서는 `docker container run kuicsofficial/echoserver`).

이미지의 용량은 수 메가바이트에서 몇백 기가바이트일 수도 있습니다. 용량이 큰 이미지는 풀할 때 오래 걸립니다. 따라서 컨테이너를 실행시키기 위한 시간이 짧게는 수 초에서 길게는 몇 분까지도 걸릴 수 있습니다. 이러한 현상을 방지하기 위해서 이미지를 풀해서 필요해지기 전에 미리 다운로드 받아 놓을 수 있습니다.

![Result of image pull](/blog/assets/2019-11-12-Docker-3/image_pull.png)

>여기서는 이미 최신 이미지가 로컬 캐시에 있으므로 Image up-to-date라고 나옵니다.

## 3. 태그와 이미지 버전

지금까지는 이미지의 태그를 특별히 지정하지 않고 사용했습니다. 도커의 이미지 레포지토리는 기본적으로 `{user}/{app}`형태를 사용합니다. 이미지의 태그는 보통 버전을 지정하기 위해 사용합니다. 태그는 `{user}/{app}:{tag}`의 형태로 지정할 수 있습니다. 따로 태그를 지정하지 않으면 `latest`태그로 지정됩니다. `docker image ls`명령어에서 `filter` 옵션을 사용해 우분투 이미지만 볼 수 있습니다.

![Result of image ls](/blog/assets/2019-11-12-Docker-3/image_ls.png)

>하나의 이미지에도 여러개의 태그가 있을 수 있습니다. 우분투의 경우에 Canonical에서 우분투에 패치를 하면 도커허브에도 코드네임과 버전을 붙여 업로드합니다. 따라서 ubuntu 16.04버전이 필요하다면 `ubuntu:16.04`로 태그를 명시함으로써 사용할 수 있습니다.

태그는 버전, 커밋 라벨, 코드네임일 수도 있습니다.

## 4. 빌드 자동화

자주 변경되지 않는 응용프로그램은 직접 이미지를 빌드하고 푸시해도 괜찮습니다. 하지만 정기적으로 이미지를 변경해야 한다면 빌드와 푸시를 자동화할 수 있습니다. 도커허브는 GitHub, BitBucket에 있는 도커파일의 자동 빌드를 지원합니다.

자동화된 빌드는 도커허브에 로그인한 후 도커허브의 레포지토리에서 Builds > Automated Builds를 통해 설정할 수 있습니다. GitHub 또는 BitBucket의 계정을 연동하고, 어떤 깃 레포지토리를 사용할 수 있는지 선택할 수 있습니다.

설정 후에 깃 레포지토리에 푸시가 들어오면 도커허브는 자동으로 도커파일을 빌드합니다. 수동으로 빌드를 시작하는 것도 가능합니다.

자동 빌드를 하면 깃의 브랜치별로 다른 태그를 붙이도록 설정할 수 있습니다.

![Example of setting tag by branch name](/blog/assets/2019-11-12-Docker-3/auto_build_tag.png)